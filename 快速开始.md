# ğŸš€ æµ·å…‰DCUç›‘æ§ç³»ç»Ÿ - å®Œæ•´æŒ‡å—

## ğŸ“– é¡¹ç›®æ¦‚è¿°

åŸºäºNVIDIA DCGM-Exporteræ”¹é€ çš„æµ·å…‰DCUç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒåŒæ¨¡å¼è¿è¡Œï¼š
- **ğŸ”¥ æµ·å…‰DCUæ¨¡å¼**: ç›‘æ§æµ·å…‰DCUè®¾å¤‡ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
- **ğŸŸ¢ NVIDIA GPUæ¨¡å¼**: åŸæœ‰NVIDIA GPUç›‘æ§åŠŸèƒ½

### âœ¨ æ ¸å¿ƒç‰¹æ€§
- âœ… **åŒæ¨¡å¼æ”¯æŒ**: ä¸€ä¸ªç¨‹åºæ”¯æŒNVIDIA GPUå’Œæµ·å…‰DCU
- âœ… **æ— ç¼åˆ‡æ¢**: é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è½»æ¾åˆ‡æ¢æ¨¡å¼
- âœ… **æ ‡å‡†å…¼å®¹**: å®Œå…¨å…¼å®¹Prometheus/Grafanaç›‘æ§æ ˆ
- âœ… **ç”Ÿäº§å°±ç»ª**: åŒ…å«å®Œæ•´çš„éƒ¨ç½²ã€ç›‘æ§å’Œæ•…éšœæ’é™¤æ–¹æ¡ˆ

### ğŸ¯ æµ·å…‰DCUæ”¯æŒçš„æŒ‡æ ‡
| æŒ‡æ ‡åç§° | æè¿° | å•ä½ |
|---------|------|------|
| `hygon_temperature` | DCUæ¸©åº¦ | Â°C |
| `hygon_avg_power` | å¹³å‡åŠŸè€— | W |
| `hygon_power_cap` | åŠŸè€—ä¸Šé™ | W |
| `hygon_dcu_usage` | DCUä½¿ç”¨ç‡ | % |
| `hygon_vram_usage` | æ˜¾å­˜ä½¿ç”¨ç‡ | % |
| `hygon_performance_mode` | æ€§èƒ½æ¨¡å¼ | 1=auto, 0=manual |
| `hygon_device_mode` | è®¾å¤‡çŠ¶æ€ | 1=Normal, 0=other |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶
- **æµ·å…‰DCUæ¨¡å¼**: ç¡®ä¿å·²å®‰è£…æµ·å…‰DCUé©±åŠ¨å’Œhy-smiå·¥å…·
- **NVIDIA GPUæ¨¡å¼**: ç¡®ä¿å·²å®‰è£…NVIDIAé©±åŠ¨å’ŒDCGM

### æ–¹æ³•1: ä½¿ç”¨é¢„ç¼–è¯‘åŒ…ï¼ˆæ¨èï¼‰

```bash
# 1. ä¸‹è½½åˆ†å‘åŒ…
wget https://your-server/hygon-dcgm-exporter-release.tar.gz

# 2. è§£å‹å®‰è£…
tar -xzf hygon-dcgm-exporter-release.tar.gz
cd hygon-dcgm-exporter-*
sudo ./install.sh

# 3. å¯åŠ¨æµ·å…‰DCUç›‘æ§
sudo systemctl start hygon-dcgm-exporter
sudo systemctl enable hygon-dcgm-exporter

# 4. éªŒè¯æœåŠ¡
curl http://localhost:9400/health
curl http://localhost:9400/metrics | grep hygon_temperature
```

### æ–¹æ³•2: æ‰‹åŠ¨è¿è¡Œ

```bash
# æµ·å…‰DCUæ¨¡å¼
./dcgm-exporter --use-hygon-mode

# NVIDIA GPUæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
./dcgm-exporter

# æŒ‡å®šé…ç½®
./dcgm-exporter --use-hygon-mode \
  --address=":9400" \
  --collectors="./etc/hygon-counters.csv" \
  --hygon-devices="f"
```

### æ–¹æ³•3: æ‰¹é‡éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ°å¤šå°æœåŠ¡å™¨
./deploy_to_servers.sh user@server1 user@server2 user@server3

# éªŒè¯éƒ¨ç½²çŠ¶æ€
./verify_deployment.sh user@server1 user@server2 user@server3
```

## ğŸŒ æœåŠ¡è®¿é—®

| æœåŠ¡ | åœ°å€ | æè¿° |
|------|------|------|
| **æŒ‡æ ‡ç«¯ç‚¹** | http://localhost:9400/metrics | PrometheusæŒ‡æ ‡ |
| **å¥åº·æ£€æŸ¥** | http://localhost:9400/health | æœåŠ¡çŠ¶æ€ |
| **Webç•Œé¢** | http://localhost:9400/ | æœåŠ¡ä¿¡æ¯ |

## ğŸ”§ é…ç½®é€‰é¡¹

### å‘½ä»¤è¡Œå‚æ•°
```bash
--use-hygon-mode              # å¯ç”¨æµ·å…‰DCUæ¨¡å¼
--address=":9400"             # ç›‘å¬åœ°å€
--collectors="path/to/file"   # æŒ‡æ ‡é…ç½®æ–‡ä»¶
--hygon-devices="f"           # ç›‘æ§çš„è®¾å¤‡ï¼ˆf=å…¨éƒ¨ï¼‰
--hy-smi-path="/path/to/cmd"  # hy-smiå‘½ä»¤è·¯å¾„
--debug                       # è°ƒè¯•æ¨¡å¼
```

### ç¯å¢ƒå˜é‡
```bash
export DCGM_EXPORTER_USE_HYGON_MODE=true
export DCGM_EXPORTER_HYGON_DEVICES_STR="f"
export DCGM_EXPORTER_HY_SMI_PATH="/usr/local/hyhal/bin/hy-smi"
export DCGM_EXPORTER_LISTEN=":9400"
export DCGM_EXPORTER_INTERVAL="30000"
```

### Prometheusé…ç½®
```yaml
scrape_configs:
  - job_name: 'hygon-dcu'
    static_configs:
      - targets: ['server1:9400', 'server2:9400']
    scrape_interval: 30s
    metrics_path: /metrics
```

## ğŸ” æ•…éšœæ’é™¤

### 1. hy-smiå‘½ä»¤æœªæ‰¾åˆ°
```bash
# æŸ¥æ‰¾hy-smiä½ç½®
find /usr -name "hy-smi" 2>/dev/null

# æŒ‡å®šå®Œæ•´è·¯å¾„
./dcgm-exporter --use-hygon-mode --hy-smi-path="/usr/local/hyhal/bin/hy-smi"

# æ·»åŠ åˆ°PATH
export PATH=$PATH:/usr/local/hyhal/bin
```

### 2. æƒé™è¢«æ‹’ç»
```bash
# æ£€æŸ¥å½“å‰ç”¨æˆ·
id

# æ·»åŠ åˆ°hygonç»„
sudo usermod -a -G hygon $USER
newgrp hygon

# æˆ–ä½¿ç”¨sudoè¿è¡Œ
sudo ./dcgm-exporter --use-hygon-mode
```

### 3. æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status hygon-dcgm-exporter

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
journalctl -u hygon-dcgm-exporter -f

# æ‰‹åŠ¨è°ƒè¯•
./dcgm-exporter --use-hygon-mode --debug
```

### 4. æŒ‡æ ‡æ•°æ®å¼‚å¸¸
```bash
# æ£€æŸ¥hy-smiè¾“å‡º
/usr/local/hyhal/bin/hy-smi

# æµ‹è¯•æŒ‡æ ‡æ¥å£
curl http://localhost:9400/metrics | head -20

# æ£€æŸ¥è®¾å¤‡æ•°é‡
curl http://localhost:9400/metrics | grep hygon_exporter_device_count
```

### 5. ç«¯å£è¢«å ç”¨
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 9400

# ä½¿ç”¨å…¶ä»–ç«¯å£
./dcgm-exporter --use-hygon-mode --address=":9401"
```

## ï¿½ï¸ å¼€å‘æ„å»º

### åœ¨LinuxæœåŠ¡å™¨ä¸Šæ„å»º
```bash
# 1. å®‰è£…Goç¯å¢ƒ
apt update && apt install -y golang-go

# 2. æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
cd /opt/dcgm-exporter-hygon
go build -o hygon-dcgm-exporter hygon_exporter.go

# 3. åˆ›å»ºåˆ†å‘åŒ…
./build_and_package.sh
```

### ä¸ºä»€ä¹ˆWindowsæ— æ³•æ„å»ºï¼Ÿ
- **CGOä¾èµ–**: NVIDIA DCGMåº“éœ€è¦Cè¯­è¨€ç»‘å®š
- **å¹³å°é™åˆ¶**: Windowsç¼ºå°‘Linuxçš„Cåº“
- **è§£å†³æ–¹æ¡ˆ**: åœ¨Linuxç¯å¢ƒæ„å»ºï¼Œç„¶ååˆ†å‘äºŒè¿›åˆ¶æ–‡ä»¶

## ğŸ“Š ç›‘æ§ç¤ºä¾‹

### æŒ‡æ ‡æŸ¥è¯¢ç¤ºä¾‹
```bash
# æŸ¥çœ‹æ‰€æœ‰æµ·å…‰DCUæŒ‡æ ‡
curl -s http://localhost:9400/metrics | grep "^hygon_"

# æŸ¥çœ‹æ¸©åº¦æŒ‡æ ‡
curl -s http://localhost:9400/metrics | grep "hygon_temperature"

# æŸ¥çœ‹ä½¿ç”¨ç‡æŒ‡æ ‡
curl -s http://localhost:9400/metrics | grep "hygon_dcu_usage"
```

### Grafanaä»ªè¡¨æ¿
åˆ›å»ºGrafanaä»ªè¡¨æ¿æ—¶ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢ï¼š
```promql
# DCUæ¸©åº¦
hygon_temperature

# DCUä½¿ç”¨ç‡
hygon_dcu_usage

# å¹³å‡åŠŸè€—
hygon_avg_power

# æ˜¾å­˜ä½¿ç”¨ç‡
hygon_vram_usage
```

## ğŸ‰ æˆåŠŸéªŒè¯

å¦‚æœçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼š
```bash
$ curl http://localhost:9400/health
HEALTHY

$ curl http://localhost:9400/metrics | grep hygon_temperature
hygon_temperature{device="0",hostname="server01",modelName="Hygon-DCU"} 55.0
```

---

**ğŸŠ æ­å–œï¼æµ·å…‰DCUç›‘æ§ç³»ç»Ÿå·²æˆåŠŸè¿è¡Œï¼**
